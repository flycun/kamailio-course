# Topos模块消息外出事件路由
# 处理Topos模块的消息外出事件，实现拓扑隐藏功能
# 确保只有来自内部网络的消息才进行拓扑隐藏处理
event_route[topos:msg-outgoing] {
  xlog("L_INFO", "topos:msg-outgoing | \n");
  
  # 检查消息源IP是否不在内部网络(172.16.254.0/24)中
  # 如果消息来自外部网络(PUBLIC->CORE)，则不进行拓扑隐藏处理
  if !(is_in_subnet($si, "172.16.254.0/24")) {
    xlog("L_INFO", "topos:msg-outgoing | request from PUBLIC->CORE. Don't strip via Topos! \n");
    # 丢弃消息，不进行拓扑隐藏处理
    drop;
  }
}

#   内部网络消息处理：

#   内部B2BUA → Kamailio → 外部用户
#   - Kamailio会修改Via头部，隐藏内部B2BUA的真实地址
#   - 外部用户只能看到Kamailio的地址，无法得知内部结构

#   外部网络消息处理：

#   外部用户 → Kamailio → 内部B2BUA
#   - 这种情况下不需要拓扑隐藏
#   - 因为消息本来就是要进入内部网络的