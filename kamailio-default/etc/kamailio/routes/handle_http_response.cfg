# 处理HTTP响应路由
# 当收到外部API的路由响应时触发，处理动态路由决策结果
# HANDLE_HTTP_RESPONSE 路由在 handle_http_request.cfg 文件中被调用
route[HANDLE_HTTP_RESPONSE] {
    # 检查HTTP响应是否成功(状态码200)
    if ($http_ok && $http_rs == 200) {
        # 记录API路由响应内容
        xlog("L_INFO","API ROUTING RESPONSE: $http_rb\n");
        
        # 从响应体中提取rtjson路由信息
        if (jansson_get("rtjson", $http_rb, "$var(rtjson)")) {
            xlog("L_INFO","rtjson key found in the body. \n");
            
            # 初始化并推送RTJSON路由
            rtjson_init_routes("$var(rtjson)");  # 初始化路由信息
            rtjson_push_routes();                # 推送路由到事务中
            
            # 转发消息到动态确定的目标
            route(RELAY);
            return;
        }
    }
    
    # HTTP请求失败或响应格式不正确，返回500错误
    send_reply(500, "API Not Available");
    exit;
}