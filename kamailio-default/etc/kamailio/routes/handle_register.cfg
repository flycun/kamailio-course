# 处理SIP REGISTER消息路由
# 实现用户注册功能，允许终端用户注册其当前位置
# 1. 检查消息是否为REGISTER方法
# 2. 验证用户身份认证
# 3. 保存用户位置信息到位置表

route[HANDLE_REGISTER] {
# This route processes REGISTER messages and saves the contact to the location table

    if(method=="REGISTER"){

        # Check for a valid entry in the subscriber table.  

        # auth_check(REALM, TABLE, FLAGS)

        # If flag = 1, then the function will check to see if the authentication username matches either 
        # To or From header username. REGISTER requests: From and To must match the authentication user

        if (!auth_check("$fd", "subscriber", "1"))  {
            auth_challenge("$fd", "0");          
            exit;                               
        }

        # If the subscriber is valid, save to the location table. 
        save("location");
        exit;
    }

}